#!/bin/bash
# XecureNet - Automated VM Optimization Tool
# Version: 1.0.0
# Author: Asim Coder (@AsimAiCoder)
# Telegram: @AsimAiCoder
# GitHub: https://github.com/asimaicoder/XecureNet
# Raw URL: https://raw.githubusercontent.com/asimaicoder/XecureNet/main/xecurenet
# CDN URL: https://cdn.jsdelivr.net/gh/asimaicoder/XecureNet@main/xecurenet
# Install: curl -fsSL https://raw.githubusercontent.com/asimaicoder/XecureNet/main/install.sh | sudo bash
# License: MIT
# Made with ‚ù§Ô∏è for the Open Source Community

set -e

VERSION="1.0.0"
CONFIG_DIR="$HOME/.xecurenet"
LOG_FILE="$CONFIG_DIR/setup.log"
CONFIG_FILE="$CONFIG_DIR/config"
SCRIPT_PATH="$(readlink -f "$0")"
SETUP_MODE=""

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
BOLD='\033[1m'
NC='\033[0m'

# Create config dir
mkdir -p "$CONFIG_DIR"

# Logging
log() { echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" >> "$LOG_FILE"; }

# Print functions
print_success() { echo -e "${GREEN}‚úì${NC} $1"; log "SUCCESS: $1"; }
print_error() { echo -e "${RED}‚úó${NC} $1"; log "ERROR: $1"; }
print_info() { echo -e "${BLUE}‚Ñπ${NC} $1"; log "INFO: $1"; }
print_warning() { echo -e "${YELLOW}‚ö†${NC} $1"; log "WARNING: $1"; }

# Banner
show_banner() {
    echo -e "${CYAN}"
    cat << "EOF"

  ‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
  ‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù
   ‚ïö‚ñà‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó     ‚ñà‚ñà‚ïë   
   ‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù     ‚ñà‚ñà‚ïë   
  ‚ñà‚ñà‚ïî‚ïù ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïë   
  ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù   ‚ïö‚ïê‚ïù   

EOF
    echo -e "${GREEN}          üîí Secure. ‚ö° Lightweight. üê≥ Container-Ready.${NC}"
    echo -e "                    ${BLUE}Version $VERSION${NC}"
    echo ""
    echo -e "                 ${MAGENTA}Made with ‚ù§Ô∏è  by Asim Coder${NC}"
    echo -e "                  ${CYAN}üì± Telegram: @AsimAiCoder${NC}"
    echo ""
}

# Check root
check_root() {
    if [[ $EUID -ne 0 ]]; then
        print_error "This script must be run as root (use sudo)"
        exit 1
    fi
}

# Select mode
select_mode() {
    echo -e "${CYAN}${BOLD}üéØ Select Setup Mode:${NC}\n"
    echo -e "${YELLOW}[1]${NC} ${BOLD}Manual Mode${NC} - Step-by-step with explanations ${GREEN}(Recommended)${NC}"
    echo -e "    ${CYAN}‚Üí${NC} You'll be asked before each action"
    echo -e "    ${CYAN}‚Üí${NC} Detailed explanations provided"
    echo -e "    ${CYAN}‚Üí${NC} Full control over the process\n"
    
    echo -e "${YELLOW}[2]${NC} ${BOLD}Agent Mode${NC} - Fully automated ${BLUE}(For experts)${NC}"
    echo -e "    ${CYAN}‚Üí${NC} No prompts, runs automatically"
    echo -e "    ${CYAN}‚Üí${NC} Faster setup (~2 minutes)"
    echo -e "    ${CYAN}‚Üí${NC} Best for CI/CD pipelines\n"
    
    while true; do
        read -p "$(echo -e "${BOLD}Your choice [1-2]:${NC} ")" mode
        case "$mode" in
            1 ) SETUP_MODE="manual"; echo -e "${GREEN}‚úì${NC} Manual Mode selected\n"; break;;
            2 ) SETUP_MODE="agent"; echo -e "${GREEN}‚úì${NC} Agent Mode selected\n"; break;;
            * ) echo -e "${RED}Please enter 1 or 2${NC}";;
        esac
    done
}

# Ask permission
ask_permission() {
    local question="$1"
    local details="$2"
    
    if [[ "$SETUP_MODE" == "agent" ]]; then
        echo -e "${GREEN}‚úì${NC} Auto-approved: $question"
        return 0
    fi
    
    echo -e "\n${YELLOW}‚ùì $question${NC}"
    if [[ -n "$details" ]]; then
        echo -e "${CYAN}‚ÑπÔ∏è  Details: $details${NC}"
    fi
    
    while true; do
        read -p "$(echo -e "${BOLD}Continue? [Y/n]:${NC} ")" choice
        case "$choice" in
            [Yy]*|"" ) return 0;;
            [Nn]* ) echo -e "${RED}‚è≠Ô∏è  Skipped${NC}"; return 1;;
            * ) echo -e "${RED}Please answer Y or N${NC}";;
        esac
    done
}

# System check
system_check() {
    echo -e "${BLUE}üîç System Check${NC}\n"
    
    if ask_permission "Check system requirements?" "Verifies OS, RAM, disk space, and internet connectivity"; then
        # OS
        if [ -f /etc/os-release ]; then
            . /etc/os-release
            print_success "OS: $PRETTY_NAME"
        fi
        
        # RAM
        RAM=$(free -m | awk '/^Mem:/{print $2}')
        print_success "RAM: ${RAM} MB"
        if [[ $RAM -lt 800 ]]; then
            print_warning "Low RAM detected. This tool is optimized for 1GB+ VMs"
        fi
        
        # Disk
        DISK=$(df -h / | awk 'NR==2{print $2}')
        print_success "Disk: $DISK"
        
        # Internet
        if ping -c 1 8.8.8.8 &> /dev/null; then
            print_success "Internet: Connected"
        else
            print_error "Internet: Not connected"
            exit 1
        fi
        echo ""
    fi
}

# Tailscale setup
setup_tailscale() {
    echo -e "${CYAN}üîê Tailscale Setup${NC}\n"
    
    if ask_permission "Install and configure Tailscale?" "Tailscale creates a secure P2P network without exposing ports. Size: ~20MB"; then
        # Install
        echo -ne "   ${CYAN}‚Üí${NC} Installing Tailscale..."
        if ! command -v tailscale &> /dev/null; then
            curl -fsSL https://tailscale.com/install.sh | sh &>> "$LOG_FILE"
            echo -e " ${GREEN}‚úì${NC}"
        else
            echo -e " ${YELLOW}Already installed${NC}"
        fi
        
        # Authentication
        echo -e "\n${CYAN}üîë Tailscale Authentication${NC}"
        echo -e "${CYAN}Choose how to authenticate:${NC}\n"
        echo -e "${YELLOW}[1]${NC} ${BOLD}Auth Key${NC} - Pre-generated key ${GREEN}(Recommended for automation)${NC}"
        echo -e "    ${CYAN}‚Üí${NC} Get key from: https://login.tailscale.com/admin/settings/keys"
        echo -e "    ${CYAN}‚Üí${NC} Best for unattended setup\n"
        
        echo -e "${YELLOW}[2]${NC} ${BOLD}OAuth${NC} - Browser login ${BLUE}(Interactive)${NC}"
        echo -e "    ${CYAN}‚Üí${NC} Opens browser for authentication"
        echo -e "    ${CYAN}‚Üí${NC} Requires active session\n"
        
        echo -e "${YELLOW}[3]${NC} ${BOLD}Skip${NC} - Configure later"
        echo -e "    ${CYAN}‚Üí${NC} You can run: sudo tailscale up\n"
        
        while true; do
            read -p "$(echo -e "${BOLD}Your choice [1-3]:${NC} ")" choice
            case $choice in
                1)
                    echo ""
                    read -p "$(echo -e "${BOLD}Enter auth key:${NC} ")" authkey
                    if [[ -n "$authkey" ]]; then
                        sudo tailscale up --authkey="$authkey" &>> "$LOG_FILE"
                        local ts_ip=$(tailscale ip -4 2>/dev/null || echo "")
                        print_success "Authenticated with auth key"
                        if [[ -n "$ts_ip" ]]; then
                            print_success "Tailscale IP: $ts_ip"
                        fi
                    else
                        print_error "No auth key provided"
                    fi
                    break
                    ;;
                2)
                    echo ""
                    print_info "Opening browser for authentication..."
                    sudo tailscale up
                    local ts_ip=$(tailscale ip -4 2>/dev/null || echo "")
                    print_success "Authenticated via OAuth"
                    if [[ -n "$ts_ip" ]]; then
                        print_success "Tailscale IP: $ts_ip"
                    fi
                    break
                    ;;
                3)
                    print_warning "Tailscale authentication skipped"
                    print_info "Run 'sudo tailscale up' later to authenticate"
                    break
                    ;;
                *)
                    echo -e "${RED}Please enter 1, 2, or 3${NC}"
                    ;;
            esac
        done
        echo ""
    fi
}

# VM Optimization
optimize_vm() {
    echo -e "${YELLOW}‚öôÔ∏è  VM Optimization${NC}\n"
    
    # Step 1: Remove bloat
    if ask_permission "Remove unnecessary packages?" "Removes unattended-upgrades, chrony, and other bloat. Saves ~100MB RAM"; then
        echo -ne "   ${CYAN}[1/6]${NC} Removing bloat..."
        sudo systemctl stop unattended-upgrades chrony 2>/dev/null || true
        sudo systemctl disable unattended-upgrades chrony 2>/dev/null || true
        sudo apt purge -y unattended-upgrades chrony &>> "$LOG_FILE"
        sudo apt autoremove -y &>> "$LOG_FILE"
        echo -e " ${GREEN}‚úì${NC} (saved ~100MB)"
    fi
    
    # Step 2: Install Podman
    if ask_permission "Install Podman?" "Lightweight container runtime. Uses 30MB RAM vs Docker's 150MB. Rootless by default"; then
        echo -ne "   ${CYAN}[2/6]${NC} Installing Podman..."
        if ! command -v podman &> /dev/null; then
            echo "deb https://download.opensuse.org/repositories/devel:/kubic:/libcontainers:/stable/Debian_12/ /" | sudo tee /etc/apt/sources.list.d/podman.list > /dev/null
            curl -fsSL https://download.opensuse.org/repositories/devel:kubic:libcontainers:stable/Debian_12/Release.key | sudo gpg --dearmor -o /etc/apt/trusted.gpg.d/podman.gpg
            sudo apt update &>> "$LOG_FILE"
            sudo apt install -y podman &>> "$LOG_FILE"
            loginctl enable-linger $SUDO_USER 2>/dev/null || true
            echo -e " ${GREEN}‚úì${NC} (30MB)"
        else
            echo -e " ${YELLOW}Already installed${NC}"
        fi
    fi
    
    # Step 3: Create swap
    if ask_permission "Create 2GB swap file?" "Swap acts as overflow RAM. Prevents OOM kills. Uses disk space"; then
        echo -ne "   ${CYAN}[3/6]${NC} Creating 2GB swap..."
        if [ ! -f /swapfile ]; then
            sudo fallocate -l 2G /swapfile
            sudo chmod 600 /swapfile
            sudo mkswap /swapfile &>> "$LOG_FILE"
            sudo swapon /swapfile
            echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab > /dev/null
            echo -e " ${GREEN}‚úì${NC}"
        else
            echo -e " ${YELLOW}Already exists${NC}"
        fi
    fi
    
    # Step 4: Optimize kernel
    if ask_permission "Optimize kernel parameters?" "Sets swappiness=10 and cache_pressure=50 for better memory management"; then
        echo -ne "   ${CYAN}[4/6]${NC} Optimizing kernel..."
        if ! grep -q "vm.swappiness=10" /etc/sysctl.conf; then
            echo 'vm.swappiness=10' | sudo tee -a /etc/sysctl.conf > /dev/null
            echo 'vm.vfs_cache_pressure=50' | sudo tee -a /etc/sysctl.conf > /dev/null
            sudo sysctl -p &>> "$LOG_FILE"
        fi
        echo -e " ${GREEN}‚úì${NC}"
    fi
    
    # Step 5: Enable auto-update
    if ask_permission "Enable container auto-updates?" "Automatically updates containers daily. Keeps your services secure"; then
        echo -ne "   ${CYAN}[5/6]${NC} Enabling auto-update..."
        sudo -u $SUDO_USER systemctl --user enable --now podman-auto-update.timer &>> "$LOG_FILE" || true
        echo -e " ${GREEN}‚úì${NC}"
    fi
    
    # Step 6: Final checks
    echo -ne "   ${CYAN}[6/6]${NC} Final checks..."
    sleep 1
    echo -e " ${GREEN}‚úì${NC}\n"
}

# Final report
show_report() {
    local ram_available=$(free -m | awk '/^Mem:/{print $7}')
    local swap_total=$(free -h | awk '/^Swap:/{print $2}')
    local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "Not configured")
    
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë${NC}                  ${GREEN}${BOLD}‚ú® SETUP COMPLETE! ‚ú®${NC}                   ${GREEN}‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}\n"
    
    echo -e "${BLUE}üìä VM Status:${NC}"
    echo "   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê"
    printf "   ‚îÇ RAM Available:       %-30s ‚îÇ\n" "${ram_available} MB"
    printf "   ‚îÇ Swap:                %-30s ‚îÇ\n" "${swap_total}"
    printf "   ‚îÇ Tailscale IP:        %-30s ‚îÇ\n" "${tailscale_ip}"
    printf "   ‚îÇ Services:            %-30s ‚îÇ\n" "Podman, Tailscale, Auto-update"
    echo "   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò"
    echo ""
    
    echo -e "${GREEN}üöÄ Next Steps:${NC}\n"
    echo -e "${YELLOW}1.${NC} Deploy your first container:"
    echo -e "   ${CYAN}podman run -d --name web -p 8080:80 nginx:alpine${NC}\n"
    
    echo -e "${YELLOW}2.${NC} Access via Tailscale:"
    if [[ "$tailscale_ip" != "Not configured" ]]; then
        echo -e "   ${CYAN}http://${tailscale_ip}:8080${NC}\n"
    else
        echo -e "   ${CYAN}Configure Tailscale first: sudo tailscale up${NC}\n"
    fi
    
    echo -e "${YELLOW}3.${NC} Check status anytime:"
    echo -e "   ${CYAN}xecurenet status${NC}\n"
    
    echo -e "${BLUE}üìù Logs:${NC} $LOG_FILE"
    echo -e "${BLUE}üí° Help:${NC} xecurenet --help\n"
}

# Self-removal
self_remove() {
    echo -e "${YELLOW}üóëÔ∏è  Cleanup${NC}\n"
    echo -e "${CYAN}Setup is complete! The ${BOLD}xecurenet${NC}${CYAN} command is now available system-wide.${NC}"
    echo -e "${CYAN}Would you like to remove this installation script?${NC}\n"
    
    read -p "$(echo -e "${BOLD}Remove installer? [y/N]:${NC} ")" remove
    case "$remove" in
        [Yy]* )
            if [[ -f "$SCRIPT_PATH" ]] && [[ "$SCRIPT_PATH" != "/usr/local/bin/xecurenet" ]]; then
                rm -f "$SCRIPT_PATH"
                echo -e "${GREEN}‚úì${NC} Installer removed: $SCRIPT_PATH"
                echo -e "${CYAN}üí° You can still use: ${BOLD}xecurenet${NC}${CYAN} command${NC}\n"
            else
                echo -e "${YELLOW}‚ö†Ô∏è  Skipped (system installation)${NC}\n"
            fi
            ;;
        * )
            echo -e "${CYAN}‚ÑπÔ∏è  Installer kept at: $SCRIPT_PATH${NC}\n"
            ;;
    esac
}

# Status command
show_status() {
    show_banner
    
    local ram_total=$(free -m | awk '/^Mem:/{print $2}')
    local ram_used=$(free -m | awk '/^Mem:/{print $3}')
    local ram_available=$(free -m | awk '/^Mem:/{print $7}')
    local swap_total=$(free -h | awk '/^Swap:/{print $2}')
    local swap_used=$(free -h | awk '/^Swap:/{print $3}')
    local tailscale_ip=$(tailscale ip -4 2>/dev/null || echo "Not configured")
    local tailscale_status=$(systemctl is-active tailscaled 2>/dev/null || echo "inactive")
    local containers=$(podman ps -q 2>/dev/null | wc -l)
    local podman_status="Active"
    command -v podman &>/dev/null || podman_status="Not installed"
    
    echo -e "${BLUE}üìä System Status${NC}\n"
    
    echo -e "   ${CYAN}Memory:${NC}"
    echo "   ‚îú‚îÄ Total:     ${ram_total} MB"
    echo "   ‚îú‚îÄ Used:      ${ram_used} MB"
    echo "   ‚îî‚îÄ Available: ${GREEN}${ram_available} MB${NC}"
    echo ""
    
    echo -e "   ${CYAN}Swap:${NC}"
    echo "   ‚îú‚îÄ Total: ${swap_total}"
    echo "   ‚îî‚îÄ Used:  ${swap_used}"
    echo ""
    
    echo -e "   ${CYAN}Network:${NC}"
    if [[ "$tailscale_ip" != "Not configured" ]]; then
        echo "   ‚îî‚îÄ Tailscale IP: ${GREEN}${tailscale_ip}${NC}"
    else
        echo "   ‚îî‚îÄ Tailscale IP: ${YELLOW}Not configured${NC}"
    fi
    echo ""
    
    echo -e "   ${CYAN}Containers:${NC}"
    echo "   ‚îî‚îÄ Running: ${GREEN}${containers}${NC}"
    echo ""
    
    echo -e "   ${CYAN}Services:${NC}"
    echo "   ‚îú‚îÄ Podman:        ${GREEN}‚úì${NC} $podman_status"
    [[ "$tailscale_status" == "active" ]] && echo "   ‚îú‚îÄ Tailscale:     ${GREEN}‚úì${NC} Connected" || echo "   ‚îú‚îÄ Tailscale:     ${YELLOW}‚ö†${NC} $tailscale_status"
    echo "   ‚îî‚îÄ Auto-update:   ${GREEN}‚úì${NC} Enabled"
    echo ""
}

# Help
show_help() {
    show_banner
    echo -e "${BOLD}Usage:${NC} xecurenet [command]\n"
    echo -e "${BOLD}Commands:${NC}"
    echo -e "   ${CYAN}setup${NC}       Initial VM setup (interactive)"
    echo -e "   ${CYAN}status${NC}      Show current VM status"
    echo -e "   ${CYAN}optimize${NC}    Re-run optimization steps"
    echo -e "   ${CYAN}tailscale${NC}   Configure Tailscale"
    echo -e "   ${CYAN}--help${NC}      Show this help message"
    echo -e "   ${CYAN}--version${NC}   Show version information\n"
    
    echo -e "${BOLD}Examples:${NC}"
    echo -e "   ${YELLOW}sudo xecurenet setup${NC}      # Run initial setup"
    echo -e "   ${YELLOW}xecurenet status${NC}          # Check VM status"
    echo -e "   ${YELLOW}sudo xecurenet optimize${NC}   # Re-optimize VM\n"
    
    echo -e "${BOLD}Support:${NC}"
    echo -e "   üì± Telegram: ${CYAN}@AsimAiCoder${NC}"
    echo -e "   üêô GitHub: ${CYAN}https://github.com/asimaicoder/XecureNet${NC}"
    echo -e "   üìñ Docs: ${CYAN}https://github.com/asimaicoder/XecureNet#readme${NC}\n"
}

# Main setup
main_setup() {
    show_banner
    check_root
    select_mode
    system_check
    setup_tailscale
    optimize_vm
    show_report
    self_remove
}

# Main
case "${1:-}" in
    setup)
        main_setup
        ;;
    status)
        show_status
        ;;
    optimize)
        check_root
        show_banner
        optimize_vm
        print_success "Optimization complete!"
        ;;
    tailscale)
        check_root
        show_banner
        setup_tailscale
        ;;
    --help|-h)
        show_help
        ;;
    --version|-v)
        echo -e "${CYAN}XecureNet${NC} v$VERSION"
        echo -e "Made with ‚ù§Ô∏è  by ${MAGENTA}Asim Coder${NC}"
        echo -e "Telegram: ${CYAN}@AsimAiCoder${NC}"
        ;;
    *)
        main_setup
        ;;
esac
